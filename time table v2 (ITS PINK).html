<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weekly Timetable + Tests Calendar</title>
  <style>
    :root{
      --bg:#0b0c10;           /* dark mode default, I gotchu */
      --panel:#111218;
      --muted:#848a98;
      --text:#e9edf3;
      --grid:#1c1f28;
      --hourline:#2a2f3b;
      --now:#ff3b30;
      --event-bg:rgba(110,168,254,.18);
      --event-border:#6ea8fe;
      --radius:14px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --start-hour:7; /* calendar starts 07:00 because fuck my uni*/
      --end-hour:22;  /* calendar ends 22:00 because my students do not sleep*/
      --px-per-min:1; /* 1px per minute => 60px per hour */
    }
    .light{
      --bg:#f6f7fb;
      --panel:#ffffff;
      --muted:#6b7280;
      --text:#101828;
      --grid:#eff1f6;
      --hourline:#e7eaf1;
      --now:#e11900;
      --event-bg:rgba(65,105,225,.12);
      --event-border:#4f46e5;
      --shadow:0 10px 25px rgba(16,24,40,.07);
    }
    

    /*  Sakura theme (pink + black) man i just really like pink okay??*/
    .sakura {
      --bg:#000000;
      --panel:#1a1a1a;
      --muted:#ff9ecd;
      --text:#ffb6d9;
      --grid:#2a2a2a;
      --hourline:#ff5fa2;
      --now:#ff4081;
      --event-bg:rgba(255,182,193,0.18);
      --event-border:#ff69b4;
      --shadow:0 10px 30px rgba(255,105,180,.3);
    }

    /* Sparkle theme (pink + white) (it was a friend request )*/
    .sparkle {
      --bg:#fff0f6;
      --panel:#ffffff;
      --muted:#d46da2;
      --text:#d63384;
      --grid:#ffe6f0;
      --hourline:#ff99cc;
      --now:#ff4da6;
      --event-bg:rgba(255,192,203,0.25);
      --event-border:#ff80bf;
      --shadow:0 10px 25px rgba(255,182,193,.4);
    }
    
*{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family:var(--font); display:flex; flex-direction:column; gap:16px}
    header{position:sticky; top:0; z-index:5; background:linear-gradient( to bottom, var(--bg) 90%, transparent); padding:18px clamp(14px,2vw,24px) 0; backdrop-filter:saturate(1.1)}
    .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .title{font-weight:700; font-size:clamp(18px,2.6vw,26px); margin-right:auto; letter-spacing:.3px}
    button, .ghost{appearance:none; border:1px solid transparent; background:var(--panel); color:var(--text); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); cursor:pointer; display:inline-flex; align-items:center; gap:8px; font-weight:600; transition:.2s}
    button:hover{transform:translateY(-1px)}
    .ghost{background:transparent; border-color:var(--grid); box-shadow:none}
    .danger{border-color:#ef4444; color:#ef4444; background:transparent}
    .controls{display:flex; gap:8px; flex-wrap:wrap}

    .wrap{padding:0 clamp(12px,2vw,22px) 24px}
    .calendar{width:100%; border-radius:var(--radius); background:var(--panel); box-shadow:var(--shadow); display:grid; grid-template-columns: 64px repeat(7, 1fr); position:relative; overflow:hidden}
    .day-head{display:grid; grid-template-columns: 64px repeat(7, 1fr); align-items:stretch}
    .day-head .cell{padding:14px 10px; text-align:center; font-weight:700; color:var(--text); border-bottom:1px solid var(--grid)}
    .day-head .timecell{background:var(--panel); border-bottom:1px solid var(--grid)}

    .grid{display:contents}
    .time-col{background:var(--panel)}
    .time-slot{height:calc(60px); display:flex; align-items:flex-start; justify-content:flex-end; padding-right:10px; color:var(--muted); font-size:12px}

    .day-col{position:relative; border-left:1px solid var(--grid)}
    .day-bg{position:absolute; inset:0; background-size:100% 60px; background-image: linear-gradient(to bottom, var(--hourline) 1px, transparent 1px); z-index:0}
    .half-lines{position:absolute; inset:0; pointer-events:none; background-size:100% 30px; background-image: linear-gradient(to bottom, transparent 14px, rgba(127,127,127,.08) 15px, transparent 16px); z-index:0}

    .now-line{position:absolute; left:0; right:0; height:2px; background:var(--now); box-shadow:0 0 0 1px rgba(255,59,48,.3); z-index:2; pointer-events:none}

    .events{position:relative; height:var(--cal-h); z-index:1}

    .event{position:absolute; left:6px; right:6px; border-radius:10px; background:var(--event-bg); border:1px solid var(--event-border); padding:8px 10px; font-size:12px; line-height:1.25; overflow:hidden; cursor:grab; user-select:none; display:flex; flex-direction:column; gap:4px; z-index:3}
    

    /* Inline trash button on events */
    .event .trash{
      position:absolute; top:6px; right:6px;
      border:none; background:transparent;
      color:var(--muted); font-size:14px;
      padding:4px; border-radius:8px; cursor:pointer;
    }
    .event .trash:hover{ background:rgba(127,127,127,.12); color:var(--text); }

.event:active{cursor:grabbing}
    .event .title{font-size:12px; font-weight:800; margin:0}
    .event .meta{font-size:11px; color:var(--muted)}
    .event .badge{display:inline-flex; gap:6px; align-items:center; font-size:11px}
    .event .dot{width:8px; height:8px; border-radius:50%; background:currentColor; opacity:.9}
    .event[data-type="Work"]{--event-border:#22c55e; --event-bg:rgba(34,197,94,.15)}
    .event[data-type="Lecture"]{--event-border:#4f46e5; --event-bg:rgba(79,70,229,.14)}
    .event[data-type="Other"]{--event-border:#f59e0b; --event-bg:rgba(245,158,11,.16)}
    .event:focus{outline:2px solid var(--accent)}
    .event .resize{position:absolute; left:0; right:0; height:6px; cursor:ns-resize}
    .event .resize.top{top:-3px}
    .event .resize.bottom{bottom:-3px}

    dialog{ border:none; border-radius:18px; padding:0; width:min(560px, 92vw); color:var(--text); background:var(--panel); box-shadow:var(--shadow)}
    dialog::backdrop{background:rgba(0,0,0,.45)}
    .modal{padding:18px}
    .modal h2{margin:0 0 12px; font-size:18px}
    .form{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .form .full{grid-column:1 / -1}
    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
    input[type="text"], input[type="time"], select, textarea, input[type="color"]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--grid); background:transparent; color:var(--text); font-size:14px}
    textarea{min-height:68px; resize:vertical}
    .modal .actions{display:flex; justify-content:space-between; gap:8px; margin-top:14px}
    .hint{color:var(--muted); font-size:12px}

    /* Tests calendar modal */
    .month-bar{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
    .month-title{font-weight:800}
    .month-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
    .dow{font-size:11px; color:var(--muted); text-align:center; padding:6px 0}
    .day{background:transparent; border:1px dashed var(--grid); border-radius:10px; padding:8px; min-height:64px; position:relative}
    .day button{width:100%; background:transparent; border:none; color:inherit; text-align:left; cursor:pointer}
    .day .num{font-weight:700; font-size:12px; opacity:.8}
    .dots{position:absolute; right:8px; bottom:6px; display:flex; gap:4px}
    .dotS{width:8px; height:8px; border-radius:50%}
    .tests-list{margin-top:14px; border-top:1px solid var(--grid); padding-top:10px; max-height:220px; overflow:auto}
    .test-item{display:flex; align-items:center; gap:8px; padding:6px 0}
    .test-color{width:12px; height:12px; border-radius:50%}
    .test-date{font-size:12px; color:var(--muted)}
  </style>
</head>
<body class="light">
  <header>
    <div class="bar wrap">
      <div class="title">Weekly Timetable</div>
      <div class="controls">
        <button id="addBtn" title="Add a new event (A)">‚ûï Add</button>
        <button class="ghost" id="exportBtn" title="Export events to JSON">‚¨áÔ∏è Export</button>
        <input type="file" id="importFile" accept="application/json" hidden />
        <button class="ghost" id="importBtn" title="Import events from JSON">‚¨ÜÔ∏è Import</button>
        <button class="ghost" id="printBtn" title="Print or save as PDF">üñ®Ô∏è Print</button>
        <button class="ghost" id="clearBtn" title="Remove all events">üóëÔ∏è Clear</button>
        <button class="ghost" id="modeBtn" title="Toggle light/dark">üåì Mode</button>
        <button class="ghost" id="testsBtn" title="Open Tests Calendar">üóìÔ∏è Tests</button>
        <button class="ghost" id="sakuraBtn" title="Sakura Theme">üå∏ Sakura</button>
        <button class="ghost" id="sparkleBtn" title="Sparkle Theme">‚ú® Sparkle</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="day-head">
      <div class="timecell cell"></div>
      <div class="cell">Mon</div>
      <div class="cell">Tue</div>
      <div class="cell">Wed</div>
      <div class="cell">Thu</div>
      <div class="cell">Fri</div>
      <div class="cell">Sat</div>
      <div class="cell">Sun</div>
    </div>

    <div id="calendar" class="calendar" aria-label="Weekly timetable">
      <div class="time-col" id="timeCol"></div>
      <div class="day-col" data-day="0"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div class="day-col" data-day="1"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div class="day-col" data-day="2"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div class="day-col" data-day="3"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div class="day-col" data-day="4"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div class="day-col" data-day="5"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div class="day-col" data-day="6"><div class="day-bg"></div><div class="half-lines"></div><div class="events"></div></div>
      <div id="nowLine" class="now-line" hidden></div>
    </div>

    <p class="hint" style="margin:10px 2px 0;">Tip: Double‚Äëclick any day to add. Click an event to edit. Drag vertically to move time, and drag left/right across columns to move days. Everything saves locally.</p>
  </div>

  <!-- Event Modal -->
  <dialog id="eventDialog">
    <form method="dialog" class="modal" id="eventForm">
      <h2 id="modalTitle">Add event</h2>
      <div class="form">
        <div class="full">
          <label for="title">Title</label>
          <input id="title" name="title" type="text" placeholder="e.g., Molecular Genetics Lecture" required />
        </div>
        <div>
          <label for="type">Type</label>
          <select id="type" name="type">
            <option>Lecture</option>
            <option>Work</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label for="day">Day</label>
          <select id="day" name="day">
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
          </select>
        </div>
        <div>
          <label for="start">Start</label>
          <input id="start" name="start" type="time" step="900" required />
        </div>
        <div>
          <label for="end">End</label>
          <input id="end" name="end" type="time" step="900" required />
        </div>
        <div>
          <label for="color">Color</label>
          <input id="color" name="color" type="color" value="#4f46e5" />
        </div>
        <div>
          <label for="location">Location</label>
          <input id="location" name="location" type="text" placeholder="e.g., VU GMC R302" />
        </div>
        <div class="full">
          <label for="notes">Notes</label>
          <textarea id="notes" name="notes" placeholder="Anything important‚Ä¶"></textarea>
        </div>
      </div>
      <div class="actions">
        <div>
          <button class="danger" value="delete" id="deleteBtn" style="display:none">Delete</button>
        </div>
        <div style="margin-left:auto; display:flex; gap:8px">
          <button class="ghost" value="cancel">Cancel</button>
          <button value="default" id="saveBtn">Save</button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Tests Calendar Modal -->
  <dialog id="testsDialog">
    <div class="modal">
      <div class="month-bar">
        <button class="ghost" id="prevMonth">‚óÄ</button>
        <div class="month-title" id="monthTitle"></div>
        <button class="ghost" id="nextMonth">‚ñ∂</button>
      </div>
      <div class="month-grid" id="monthGrid"></div>
      <div class="tests-list" id="testsList"></div>
      <div class="actions" style="margin-top:10px">
        <button class="ghost" id="closeTests">Close</button>
        <div style="margin-left:auto; display:flex; gap:8px">
          <button id="exportTests" class="ghost">Export</button>
          <input type="file" id="importTestsFile" accept="application/json" hidden />
          <button id="importTests" class="ghost">Import</button>
          <button id="clearTests" class="danger">Clear</button>
        </div>
      </div>
    </div>
  </dialog>

  <script>
    // ---------- Utilities ----------
    const qs = (s, el=document) => el.querySelector(s);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
    const START_HOUR = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--start-hour')) || 7;
    const END_HOUR   = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--end-hour')) || 22;
    const PX_PER_MIN = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--px-per-min')) || 1;
    const STORAGE_KEY = 'weeklyTimetable.v1';
    const TESTS_KEY = 'weeklyTimetable.tests.v1';
    function pad(n){ return String(n).padStart(2,'0'); }
    function toMinutes(t){ if(!t) return 0; const [h,m] = t.split(':').map(Number); return h*60+m; }
    function minutesToTime(min){ min=((min%1440)+1440)%1440; const h=Math.floor(min/60), m=Math.round(min%60); return `${pad(h)}:${pad(m)}`; }
    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function snap(mins, step=30){ return Math.round(mins/step)*step; }
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[c]); }
    function hexToRgba(hex,a=.16){ try{ const h=hex.replace('#',''); const b=parseInt(h,16); const r=h.length===3?((b>>8)&0xF)*17:(b>>16)&0xFF; const g=h.length===3?((b>>4)&0xF)*17:(b>>8)&0xFF; const bl=h.length===3?(b&0xF)*17:(b&0xFF); return `rgba(${r},${g},${bl},${a})`; }catch{ return 'rgba(79,70,229,.16)'; } }

    // ---------- State ----------
    let events = [];
    let editingId = null;
    let tests = []; // {id, date:'YYYY-MM-DD', title, color}

    // ---------- Build time column ----------
    function buildTimeCol(){
      const timeCol = qs('#timeCol');
      timeCol.innerHTML='';
      const totalMinutes = (END_HOUR-START_HOUR)*60;
      const calHeight = totalMinutes*PX_PER_MIN;
      document.querySelectorAll('.events').forEach(el=>el.style.height=calHeight+'px');
      document.querySelectorAll('.day-col').forEach(el=>el.style.minHeight=calHeight+'px');
      document.documentElement.style.setProperty('--cal-h', calHeight+'px');
      for(let h=START_HOUR; h<=END_HOUR; h++){
        const row=document.createElement('div'); row.className='time-slot'; row.style.height=(60*PX_PER_MIN)+'px'; row.textContent=`${pad(h)}:00`; timeCol.appendChild(row);
      }
    }

    // ---------- Render events ----------
    function render(){
      qsa('.events').forEach(c=>c.innerHTML='');
      for(const ev of events){
        const col = qs(`.day-col[data-day="${ev.day}"] .events`); if(!col) continue;
        const startMin=toMinutes(ev.start), endMin=toMinutes(ev.end);
        const top=(startMin-START_HOUR*60)*PX_PER_MIN; const h=Math.max(20,(endMin-startMin)*PX_PER_MIN);
        const node=document.createElement('div'); node.className='event'; node.tabIndex=0; node.dataset.id=ev.id; node.dataset.type=ev.type||'Other';
        node.style.top=top+'px'; node.style.height=h+'px'; node.style.borderColor=ev.color||'var(--event-border)'; node.style.background=hexToRgba(ev.color||'#4f46e5',.16);
        node.innerHTML = `
          <div class="resize top" data-dir="top" aria-hidden="true"></div>
          <button class="trash" title="Delete this event" aria-label="Delete">üóëÔ∏è</button>
          <p class="title">${escapeHtml(ev.title)}</p>
          <div class="meta">${ev.start}‚Äì${ev.end}${ev.location? ' ¬∑ ' + escapeHtml(ev.location): ''}</div>
          ${ev.type? `<span class="badge" style="color:${ev.color}"><span class="dot"></span>${ev.type}</span>`: ''}
          <div class="resize bottom" data-dir="bottom" aria-hidden="true"></div>
        `;
        col.appendChild(node);
        // delete just this event via inline trash button
        node.querySelector('.trash').addEventListener('click', (e) => {
          e.stopPropagation();
          const idx = events.findIndex(x => x.id === ev.id);
          if(idx > -1){ events.splice(idx,1); save(); render(); }
        });
      }
    }

    // ---------- Storage ----------
    function load(){
      try{ events = JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }catch{ events=[]; }
      try{ tests = JSON.parse(localStorage.getItem(TESTS_KEY)) || []; }catch{ tests=[]; }
    }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }
    function saveTests(){ localStorage.setItem(TESTS_KEY, JSON.stringify(tests)); }

    // ---------- Event Modal helpers ----------
    const dlg = qs('#eventDialog');
    const form = qs('#eventForm');
    function openCreate(pref={}){
      editingId=null; form.reset(); qs('#modalTitle').textContent='Add event'; qs('#deleteBtn').style.display='none';
      qs('#title').value=pref.title||''; qs('#type').value=pref.type||'Lecture'; qs('#day').value=String(pref.day??0);
      qs('#start').value=pref.start||'09:00'; qs('#end').value=pref.end||'10:00'; qs('#color').value=pref.color||'#4f46e5';
      qs('#location').value=pref.location||''; qs('#notes').value=pref.notes||''; dlg.showModal();
    }
    function openEdit(ev){
      editingId=ev.id; qs('#modalTitle').textContent='Edit event'; qs('#deleteBtn').style.display='inline-flex';
      qs('#title').value=ev.title; qs('#type').value=ev.type||'Other';
      qs('#day').value=String(ev.day);
      qs('#start').value=ev.start; qs('#end').value=ev.end; qs('#color').value=ev.color||'#4f46e5';
      qs('#location').value=ev.location||''; qs('#notes').value=ev.notes||''; dlg.showModal();
    }
    form.addEventListener('submit', (e)=> e.preventDefault());
    form.addEventListener('click', (e)=>{
      const val=e.target?.value;
      if(val==='cancel'){ dlg.close(); return; }
      if(val==='delete'){
        if(editingId!=null){ const idx=events.findIndex(x=>x.id===editingId); if(idx>-1) events.splice(idx,1); save(); render(); }
        dlg.close(); return;
      }
      if(val==='default'){
        const ev={ id: editingId ?? crypto.randomUUID(), title: qs('#title').value.trim()||'Untitled', type: qs('#type').value, day: parseInt(qs('#day').value,10), start: qs('#start').value, end: qs('#end').value, color: qs('#color').value, location: qs('#location').value.trim(), notes: qs('#notes').value.trim() };
        if(toMinutes(ev.end) <= toMinutes(ev.start)){ alert('End time must be after start time.'); return; }
        if(editingId==null){ events.push(ev);} else { const idx=events.findIndex(x=>x.id===editingId); if(idx>-1) events[idx]=ev; }
        save(); render(); dlg.close();
      }
    });

    // Sakura + Sparkle theme buttons
    qs('#sakuraBtn').addEventListener('click', () => {
      document.body.classList.remove('light','sakura','sparkle');
      document.body.classList.add('sakura');
      localStorage.setItem('timetableTheme','sakura');
    });
    qs('#sparkleBtn').addEventListener('click', () => {
      document.body.classList.remove('light','sakura','sparkle');
      document.body.classList.add('sparkle');
      localStorage.setItem('timetableTheme','sparkle');
    });

    // ---------- Interactions ----------
    qs('#addBtn').addEventListener('click', ()=> openCreate({}));
    qsa('.day-col').forEach(col=>{
      col.addEventListener('dblclick', (e)=>{
        if(e.target.closest('.event')) return;
        const rect=col.getBoundingClientRect(); const day=parseInt(col.dataset.day,10); const y=e.clientY-rect.top; const minsFromStart=Math.max(0, y/PX_PER_MIN); const absMins=START_HOUR*60 + snap(minsFromStart, 30); const start=minutesToTime(absMins); const end=minutesToTime(absMins+60); openCreate({day,start,end});
      });
    });
    // click or double-click to edit
    qs('#calendar').addEventListener('click', (e)=>{ const card=e.target.closest('.event'); if(!card) return; const id=card.dataset.id; const ev=events.find(x=>x.id===id); if(ev) openEdit(ev); });
    qs('#calendar').addEventListener('dblclick', (e)=>{ const card=e.target.closest('.event'); if(!card) return; const id=card.dataset.id; const ev=events.find(x=>x.id===id); if(ev) openEdit(ev); });

    // Drag & Resize (now supports horizontal day switching)
    let drag=null; // {id, startY, startX, origTop, origHeight, mode, col}
    function onPointerDown(e){
      // Ignore clicks on trash button so drag doesn't start
      if (e.target && e.target.closest && e.target.closest('.trash')) return;
      const card=e.target.closest('.event'); if(!card) return; e.preventDefault();
      const handle=e.target.closest('.resize'); const id=card.dataset.id; const col=card.closest('.day-col');
      drag={id, startY:e.clientY, startX:e.clientX, origTop:parseFloat(card.style.top), origHeight:parseFloat(card.style.height), mode: handle? (handle.dataset.dir==='top'?'top':'bottom') : 'move', col};
      card.setPointerCapture?.(e.pointerId||1); document.addEventListener('pointermove', onPointerMove); document.addEventListener('pointerup', onPointerUp, {once:true});
    }
    function onPointerMove(e){
      if(!drag) return; const dy=e.clientY-drag.startY; const dx=e.clientX-drag.startX; const card=qs(`.event[data-id="${drag.id}"]`); if(!card) return; const ev=events.find(x=>x.id===drag.id);
      const minTop=0, maxTop=(END_HOUR-START_HOUR)*60*PX_PER_MIN-10;

      // Horizontal: detect new day column under pointer and move if needed
      const cols=qsa('.day-col');
      for(const c of cols){ const r=c.getBoundingClientRect(); if(e.clientX>=r.left && e.clientX<=r.right){ const newDay=parseInt(c.dataset.day,10); if(newDay!==ev.day){ ev.day=newDay; c.querySelector('.events').appendChild(card); drag.col=c; } break; } }

      if(drag.mode==='move'){
        let newTop=clamp(drag.origTop+dy, minTop, maxTop); card.style.top=newTop+'px'; const newStartMin=START_HOUR*60 + snap(newTop/PX_PER_MIN, 15); const duration=toMinutes(ev.end)-toMinutes(ev.start); ev.start=minutesToTime(newStartMin); ev.end=minutesToTime(newStartMin+duration);
      } else if(drag.mode==='top'){
        let newTop=clamp(drag.origTop+dy, minTop, drag.origTop+drag.origHeight-30); card.style.top=newTop+'px'; const newStartMin=START_HOUR*60 + snap(newTop/PX_PER_MIN, 15); ev.start=minutesToTime(newStartMin); card.style.height=(drag.origHeight+(drag.origTop-newTop))+'px';
      } else if(drag.mode==='bottom'){
        let newH=Math.max(20, drag.origHeight+dy); const limit=(END_HOUR-START_HOUR)*60*PX_PER_MIN - drag.origTop; newH=clamp(newH,20,limit); card.style.height=newH+'px'; const startAbs=toMinutes(ev.start); const newEndMin=startAbs + snap(newH/PX_PER_MIN, 15); ev.end=minutesToTime(newEndMin);
      }
      save(); const meta=card.querySelector('.meta'); if(meta){ meta.textContent=`${ev.start}‚Äì${ev.end}${ev.location? ' ¬∑ ' + ev.location: ''}` }
    }
    function onPointerUp(){ document.removeEventListener('pointermove', onPointerMove); drag=null; render(); }
    qs('#calendar').addEventListener('pointerdown', onPointerDown);

    // Export/Import/Print/Clear/Mode
    qs('#exportBtn').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(events,null,2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='weekly-timetable.json'; a.click(); URL.revokeObjectURL(url); });
    qs('#importBtn').addEventListener('click', ()=> qs('#importFile').click());
    qs('#importFile').addEventListener('change', async (e)=>{ const file=e.target.files?.[0]; if(!file) return; try{ const text=await file.text(); const data=JSON.parse(text); if(Array.isArray(data)){ events=data.filter(v=>v&&typeof v==='object'); save(); render(); } else alert('Invalid file.'); }catch(err){ alert('Could not import: '+err.message);} e.target.value=''; });
    qs('#printBtn').addEventListener('click', ()=> window.print());
    qs('#clearBtn').addEventListener('click', ()=>{ if(confirm('Remove all events?')){ events=[]; save(); render(); }});
    qs('#modeBtn').addEventListener('click', () => {
      // toggle only dark/light and remember it
      const wasLight = document.body.classList.contains('light');
      document.body.classList.remove('sakura','sparkle');
      document.body.classList.toggle('light');
      localStorage.setItem('timetableTheme', wasLight ? 'dark' : 'light');
    });

    // Avoid hotkey interfering with typing in inputs
    window.addEventListener('keydown', (e)=>{
      const tag = (e.target && (e.target.tagName||'')).toLowerCase();
      const typing = ['input','textarea','select'].includes(tag) || e.target.isContentEditable || dlg.open || qs('#testsDialog').open;
      if(!typing && e.key.toLowerCase()==='a'){ openCreate({}); }
    });

    // Now line
    function updateNowLine(){
      const nl=qs('#nowLine'); const d=new Date(); const day=(d.getDay()+6)%7; const mins=d.getHours()*60+d.getMinutes();
      if(mins < START_HOUR*60 || mins > END_HOUR*60){ nl.hidden=true; return; }
      const top=(mins-START_HOUR*60)*PX_PER_MIN; const headHeight=qs('.day-head .cell').offsetHeight; const calRect=qs('.calendar').getBoundingClientRect();
      nl.style.top=headHeight+top+'px'; const dayCol=qsa('.day-col')[day]; const colRect=dayCol.getBoundingClientRect(); nl.style.left=(colRect.left-calRect.left)+'px'; nl.style.width=colRect.width+'px'; nl.hidden=false;
    }

    function initTheme(){
      const t = localStorage.getItem('timetableTheme') || 'light';
      document.body.classList.remove('light','sakura','sparkle'); // base: dark
      if(t !== 'dark') document.body.classList.add(t);
    }

    // ---------- Tests Calendar ----------
    const testsDlg = qs('#testsDialog');
    const monthTitle = qs('#monthTitle');
    const monthGrid = qs('#monthGrid');
    const testsList = qs('#testsList');
    let currentMonth = new Date(); currentMonth.setDate(1);

    qs('#testsBtn').addEventListener('click', ()=>{ renderMonth(); testsDlg.showModal(); });
    qs('#closeTests').addEventListener('click', ()=> testsDlg.close());
    qs('#prevMonth').addEventListener('click', ()=>{ currentMonth.setMonth(currentMonth.getMonth()-1); renderMonth(); });
    qs('#nextMonth').addEventListener('click', ()=>{ currentMonth.setMonth(currentMonth.getMonth()+1); renderMonth(); });
    qs('#exportTests').addEventListener('click', ()=>{ const blob=new Blob([JSON.stringify(tests,null,2)], {type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tests-calendar.json'; a.click(); URL.revokeObjectURL(url); });
    qs('#importTests').addEventListener('click', ()=> qs('#importTestsFile').click());
    qs('#importTestsFile').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; try{ const t=await f.text(); const data=JSON.parse(t); if(Array.isArray(data)){ tests=data; saveTests(); renderMonth(); } else alert('Invalid file.'); }catch(err){ alert('Could not import: '+err.message);} e.target.value=''; });
    qs('#clearTests').addEventListener('click', ()=>{ if(confirm('Remove all tests?')){ tests=[]; saveTests(); renderMonth(); }});

    function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

    function renderMonth(){
      const year=currentMonth.getFullYear(); const month=currentMonth.getMonth();
      monthTitle.textContent = currentMonth.toLocaleString(undefined, {month:'long', year:'numeric'});
      monthGrid.innerHTML='';
      const dow=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      for(const d of dow){ const el=document.createElement('div'); el.className='dow'; el.textContent=d; monthGrid.appendChild(el); }
      const first = new Date(year, month, 1); const firstDow=(first.getDay()+6)%7; // Mon=0
      const daysInMonth = new Date(year, month+1, 0).getDate();
      for(let i=0;i<firstDow;i++){ const gap=document.createElement('div'); gap.className='day'; gap.style.visibility='hidden'; monthGrid.appendChild(gap); }
      for(let day=1; day<=daysInMonth; day++){
        const cell=document.createElement('div'); cell.className='day';
        const date=new Date(year, month, day); const idate=ymd(date);
        const btn=document.createElement('button'); btn.innerHTML=`<span class="num">${day}</span>`; btn.addEventListener('click', ()=> addTestPrompt(idate)); cell.appendChild(btn);
        const dots=document.createElement('div'); dots.className='dots';
        const dayTests=tests.filter(t=>t.date===idate).slice(0,4);
        for(const t of dayTests){ const dot=document.createElement('span'); dot.className='dotS'; dot.style.background = t.color || '#ef4444'; dots.appendChild(dot); }
        cell.appendChild(dots);
        monthGrid.appendChild(cell);
      }
      renderTestsList();
    }

    function renderTestsList(){
      testsList.innerHTML='';
      if(!tests.length){ testsList.innerHTML='<span class="hint">No tests yet. Click a day to add one.</span>'; return; }
      const sorted=[...tests].sort((a,b)=> a.date.localeCompare(b.date));
      for(const t of sorted){
        const row=document.createElement('div'); row.className='test-item';
        row.innerHTML=`<span class="test-color" style="background:${t.color||'#ef4444'}"></span>
          <strong>${escapeHtml(t.title)}</strong>
          <span class="test-date">${t.date}</span>`;
        const del=document.createElement('button'); del.className='ghost'; del.textContent='Delete'; del.addEventListener('click', ()=>{ const idx=tests.findIndex(x=>x.id===t.id); if(idx>-1){ tests.splice(idx,1); saveTests(); renderMonth(); }});
        row.appendChild(del); testsList.appendChild(row);
      }
    }

    function addTestPrompt(dateStr){
      const title = prompt(`Add test on ${dateStr}:\nTitle`);
      if(!title) return;
      const color = prompt('Color (hex like #ef4444). Leave empty for default:') || '#ef4444';
      const item = {id: crypto.randomUUID(), date: dateStr, title: title.trim(), color};
      tests.push(item); saveTests(); renderMonth();
    }

    // ---------- Boot ----------
    function init(){ initTheme(); buildTimeCol(); load(); render(); updateNowLine(); setInterval(updateNowLine, 60*1000); window.addEventListener('resize', updateNowLine); }
    init();
  </script>
</body>
</html>
